#include <proto/exec.h>
#include <proto/dos.h>
#include <proto/camd.h>
#include <proto/timer.h>
#include <midi/mididefs.h>
#include "oca.h"
#include "midisupport.h"
#include "vumetersupport.h"

/* 0.25 dB breakpoints, counting down from 0dBFS
 * for limit voltage of 2147483647
 */
int32 dBTable32[128] =
{
	2027355327, 1913946815, 1806882368, 1705806912, 1610385599, 1520302015, 1435257664, 1354970559, 
	1279174720, 1207618880, 1140065727, 1076291392, 1016084640, 959245728, 905586399, 854928672, 
	807104735, 761956000, 719332831, 679093983, 641106080, 605243168, 571386400, 539423520, 
	509248656, 480761744, 453868335, 428479343, 404510575, 381882607, 360520431, 340353232, 
	321314192, 303340176, 286371567, 270352208, 255228936, 240951656, 227473032, 214748392, 
	202735543, 191394696, 180688247, 170580712, 161038568, 152030216, 143525783, 135497079, 
	127917483, 120761892, 114006580, 107629147, 101608468, 95924580, 90558644, 85492875, 
	80710475, 76195604, 71933291, 67909403, 64110610, 60524317, 57138642, 53942357, 
	50924874, 48076181, 45386842, 42847941, 40451066, 38188266, 36052050, 34035330, 
	32131422, 30334018, 28637161, 27035222, 25522897, 24095169, 22747305, 21474841, 
	20273557, 19139473, 18068826, 17058073, 16103859, 15203023, 14352579, 13549708, 
	12791749, 12076190, 11400659, 10762916, 10160848, 9592459, 9055865, 8549288, 
	8071048, 7619561, 7193329, 6790941, 6411061, 6052432, 5713864, 5394236, 
	5092487, 4807618, 4538684, 4284794, 4045106, 3818826, 3605204, 3403532, 
	3213142, 3033401, 2863716, 2703522, 2552289, 2409516, 2274730, 2147484, 
	2027355, 1913947, 1806882, 1705807, 1610385, 1520302, 1435257, 1
};


/* 0.25 dB breakpoints, counting down from 0dBFS
 * for limit voltage of 8388607
 */
int32 dBTable24[128] =
{
	7919355, 7476353, 7058133, 6663307, 6290568, 5938679, 5606474, 5292853, 
	4996775, 4717260, 4453381, 4204262, 3969080, 3747053, 3537446, 3339564, 
	3152752, 2976390, 2809893, 2652710, 2504320, 2364230, 2231977, 2107122, 
	1989252, 1877975, 1772922, 1673747, 1580119, 1491728, 1408282, 1329504, 
	1255133, 1184922, 1118638, 1056063, 996987, 941217, 888566, 838860, 
	791935, 747635, 705813, 666330, 629056, 593867, 560647, 529285, 
	499677, 471726, 445338, 420426, 396908, 374705, 353744, 333956, 
	315275, 297639, 280989, 265271, 250432, 236423, 223197, 210712, 
	198925, 187797, 177292, 167374, 158011, 149172, 140828, 132950, 
	125513, 118492, 111863, 105606, 99698, 94121, 88856, 83886, 
	79193, 74763, 70581, 66633, 62905, 59386, 56064, 52928, 
	49967, 47172, 44533, 42042, 39690, 37470, 35374, 33395, 
	31527, 29763, 28098, 26527, 25043, 23642, 22319, 21071, 
	19892, 18779, 17729, 16737, 15801, 14917, 14082, 13295, 
	12551, 11849, 11186, 10560, 9969, 9412, 8885, 8388, 
	7919, 7476, 7058, 6663, 6290, 5938, 5606, 1
};


/* 0.25 dB breakpoints, counting down from 0dBFS
 * for limit voltage of 32767
 */
int32 dBTable16[128] =
{
	30934, 29203, 27569, 26027, 24571, 23197, 21899, 20674, 
	19518, 18426, 17395, 16422, 15503, 14636, 13817, 13044, 
	12315, 11626, 10975, 10361, 9782, 9234, 8718, 8230, 
	7770, 7335, 6925, 6537, 6172, 5826, 5500, 5193, 
	4902, 4628, 4369, 4125, 3894, 3676, 3470, 3276, 
	3093, 2920, 2756, 2602, 2457, 2319, 2189, 2067, 
	1951, 1842, 1739, 1642, 1550, 1463, 1381, 1304, 
	1231, 1162, 1097, 1036, 978, 923, 871, 823, 
	777, 733, 692, 653, 617, 582, 550, 519, 
	490, 462, 436, 412, 389, 367, 347, 327, 
	309, 292, 275, 260, 245, 231, 218, 206, 
	195, 184, 173, 164, 155, 146, 138, 130, 
	123, 116, 109, 103, 97, 92, 87, 82, 
	77, 73, 69, 65, 61, 58, 55, 51, 
	49, 46, 43, 41, 38, 36, 34, 32, 
	30, 29, 27, 26, 24, 23, 21, 1
};

int8 midiLimits(int32 value)
{
	if(value < 0)   {return(0);}
	if(value > 127) {return(127);}
	return(value);
}

int32 senddBDown(struct AudioDevice *uaud, int32 peak, int32 magnitude, int8 note, struct MidiLink *link)
{
	int32 index = 0, *table;
	// select the correct table for the sample size given
	if     (magnitude==32){table = dBTable32;}
	else if(magnitude==24){table = dBTable24;}
	else if(magnitude==16){table = dBTable16;}
	else                  {return(0);}

	// lookup deciBel from peak value.
	int32 bit = 7, bitMask;
	while(bit--)
	{
		bitMask = 1L << bit;
		if(table[index | bitMask] > peak)
		{
			index |= bitMask;
		}
	}

	MidiMsg mmsg;
	mmsg.mm_Status = MS_NoteOn;
	mmsg.mm_Data1 = note;
	mmsg.mm_Data2 = midiLimits(127-index);
	ICamd->PutMidi(link, mmsg.mm_Msg);

	return(127 - index);
}

// post/repost a repetitive timer.
void postTimer(struct AudioDevice *adev, uint32 delayms) 
{
	uint32 clockRes;
	struct EClockVal *ec = 
		(struct EClockVal *)&TimerIoReq->Time;
	clockRes = ITimer->ReadEClock(ec);
	uint64 *etime = (uint64 *)ec;
	uint32 inctime = clockRes / 1000 * delayms;
	*etime += inctime;
	TimerIoReq->Request.io_Command = TR_ADDREQUEST;
	IExec->SendIO(&TimerIoReq->Request);
	TimerPosted = TRUE;
}

